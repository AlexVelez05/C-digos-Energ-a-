/*
 * SISTEMA DE MONITOREO DE ENERG√çA CON ESP32
 * Este programa mide voltaje y corriente en tres l√≠neas, almacena datos en SD
 * y los env√≠a a ThingsBoard via MQTT
 */

// ============ SECCI√ìN 1: BIBLIOTECAS ============
#include "EmonLib.h"           // Biblioteca para medici√≥n de energ√≠a
#include "virtuabotixRTC.h"    // Biblioteca para el RTC (Reloj de Tiempo Real)
#include <SD.h>                // Biblioteca para manejar tarjeta SD
#include <SPI.h>               // Biblioteca para comunicaci√≥n SPI
#include <WiFi.h>              // Biblioteca para conexi√≥n WiFi
#include <PubSubClient.h>      // Biblioteca cliente MQTT

// ============ SECCI√ìN 2: CONFIGURACI√ìN DE PINES ============
// Pines para el RTC DS1302
#define CLK_PIN 14     // Pin de reloj para el RTC
#define DAT_PIN 27     // Pin de datos para el RTC
#define RST_PIN 26     // Pin de reset para el RTC

// Pines para los sensores (ADC)
#define VOLTAGE 36     // Pin ADC para medir voltaje (GPIO36)
#define CURRENT1 39    // Pin ADC para medir corriente l√≠nea 1 (GPIO39)
#define CURRENT2 32    // Pin ADC para medir corriente l√≠nea 2 (GPIO32)
#define CURRENT3 33    // Pin ADC para medir corriente l√≠nea 3 (GPIO33)

// Pines para la tarjeta SD
#define SD_CS 5        // Pin Chip Select para tarjeta SD (GPIO5)
#define SD_MOSI 23     // Pin MOSI para comunicaci√≥n SPI (GPIO23)
#define SD_MISO 19     // Pin MISO para comunicaci√≥n SPI (GPIO19)
#define SD_SCK 18      // Pin SCK para comunicaci√≥n SPI (GPIO18)

// ============ SECCI√ìN 3: CONSTANTES DE CALIBRACI√ìN ============
#define VOLT_CAL 123.8      // Constante de calibraci√≥n para medici√≥n de voltaje
#define CURRENT_CAL 15.4    // Constante de calibraci√≥n para medici√≥n de corriente

// ============ SECCI√ìN 4: CONFIGURACI√ìN WiFi y MQTT ============
const char* ssid = "ALUMNOS";                   // Nombre de la red WiFi
const char* password = "alumn05ier";            // Contrase√±a de la red WiFi
const char* mqttServer = "tb.ier.unam.mx";      // Servidor MQTT de ThingsBoard
const char* deviceToken = "jwV4TIyt7cch3q1OhLUf"; // Token del dispositivo en ThingsBoard

// ============ SECCI√ìN 5: DECLARACI√ìN DE OBJETOS ============
virtuabotixRTC myRTC(CLK_PIN, DAT_PIN, RST_PIN);  // Objeto para controlar el RTC
EnergyMonitor emon1, emon2, emon3;                // Objetos para medici√≥n de energ√≠a
WiFiClient espClient;                             // Cliente WiFi para ESP32
PubSubClient client(espClient);                   // Cliente MQTT que usa el cliente WiFi

// ============ SECCI√ìN 6: VARIABLES DE TIEMPO ============
unsigned long intervalSensors = 1000;        // Intervalo para lectura de sensores (1 segundo)
unsigned long previousMillisSensors = 0;     // Marca de tiempo de la √∫ltima lectura de sensores
unsigned long intervalDataLog = 10000;       // Intervalo para guardar en SD (10 segundos)
unsigned long previousMillisDL = 0;          // Marca de tiempo del √∫ltimo guardado en SD
unsigned long previousMillisMQTT = 0;        // Marca de tiempo del √∫ltimo env√≠o MQTT
const unsigned long intervalMQTT = 5000;     // Intervalo para env√≠o a ThingsBoard (5 segundos)

// ============ SECCI√ìN 7: VARIABLES DE MEDICI√ìN ============
float volt = 0;     // Variable para almacenar el valor de voltaje medido
float line1 = 0;    // Variable para almacenar la corriente de la l√≠nea 1
float line2 = 0;    // Variable para almacenar la corriente de la l√≠nea 2
float line3 = 0;    // Variable para almacenar la corriente de la l√≠nea 3

// ============ SECCI√ìN 8: BUFFER PARA DATOS ============
char buf[100];      // Buffer para formatear datos antes de guardar en SD

// ============ SECCI√ìN 9: CONFIGURACI√ìN INICIAL ============
void setup() {
  Serial.begin(115200);           // Inicializar comunicaci√≥n serial a 115200 baudios
  while (!Serial);                // Esperar a que se inicie el puerto serial (solo para algunas placas)

  // Configuraci√≥n del RTC (descomentar solo para configurar hora inicial una vez)
  // myRTC.setDS1302Time(0, 0, 0, 1, 1, 2023); // seg, min, hora, dia, mes, a√±o

  // Configurar monitores de energ√≠a
  emon1.voltage(VOLTAGE, VOLT_CAL, 1.4);  // Configurar pin y calibraci√≥n para medici√≥n de voltaje
  emon1.current(CURRENT1, CURRENT_CAL);   // Configurar pin y calibraci√≥n para medici√≥n de corriente l√≠nea 1
  emon2.current(CURRENT2, CURRENT_CAL);   // Configurar pin y calibraci√≥n para medici√≥n de corriente l√≠nea 2
  emon3.current(CURRENT3, CURRENT_CAL);   // Configurar pin y calibraci√≥n para medici√≥n de corriente l√≠nea 3

  // Inicializar tarjeta SD con configuraci√≥n SPI personalizada
  SPI.begin(SD_SCK, SD_MISO, SD_MOSI, SD_CS);  // Inicializar comunicaci√≥n SPI con pines personalizados
  
  Serial.print("Iniciando tarjeta SD...");  // Mensaje de inicio de inicializaci√≥n de SD
  if (!SD.begin(SD_CS)) {              // Intentar inicializar tarjeta SD con el pin CS especificado
    Serial.println("¬°Fallo en inicializaci√≥n!");  // Mensaje de error si falla la inicializaci√≥n
    while (1);                         // Detener ejecuci√≥n indefinidamente si falla
  }
  Serial.println("Inicializaci√≥n correcta.");  // Mensaje de √©xito en inicializaci√≥n

  // Crear archivo con encabezados si no existe
  if (!SD.exists("/datalog.csv")) {    // Verificar si el archivo ya existe
    File dataFile = SD.open("/datalog.csv", FILE_WRITE);  // Abrir archivo en modo escritura
    if (dataFile) {                    // Verificar si se abri√≥ correctamente
      dataFile.println("Fecha,Hora,Tension(V),Corriente1(A),Corriente2(A),Corriente3(A)");  // Escribir encabezados
      dataFile.close();                // Cerrar archivo
      Serial.println("Archivo creado con encabezados");  // Mensaje de confirmaci√≥n
    } else {
      Serial.println("Error al crear archivo!");  // Mensaje de error
    }
  }

  // Conectar al WiFi
  WiFi.begin(ssid, password);          // Iniciar conexi√≥n WiFi con credenciales
  Serial.print("Conectando al WiFi...");  // Mensaje de inicio de conexi√≥n
  while (WiFi.status() != WL_CONNECTED) {  // Esperar hasta que se establezca la conexi√≥n
    delay(1000);                    // Esperar 1 segundo entre intentos
    Serial.print(".");              // Mostrar punto como indicador de progreso
  }
  Serial.println("\n‚úÖ Conectado al WiFi");  // Mensaje de conexi√≥n exitosa

  // Configurar servidor MQTT y conectar
  client.setServer(mqttServer, 1883);  // Establecer servidor MQTT y puerto
  reconnectMQTT();                     // Llamar funci√≥n para conectar a MQTT
}

// ============ SECCI√ìN 10: BUCLE PRINCIPAL ============
void loop() {
  unsigned long currentMillis = millis();  // Obtener tiempo actual en milisegundos

  // Lectura peri√≥dica de sensores (cada 1 segundo)
  if (currentMillis - previousMillisSensors >= intervalSensors) {  // Verificar si ha pasado el intervalo
    previousMillisSensors = currentMillis;  // Actualizar marca de tiempo
    readSensors();              // Llamar funci√≥n para leer valores de sensores
    printSerialData();          // Llamar funci√≥n para mostrar datos por serial
  }

  // Guardado peri√≥dico en SD (cada 10 segundos)
  if (currentMillis - previousMillisDL >= intervalDataLog) {  // Verificar si ha pasado el intervalo
    previousMillisDL = currentMillis;  // Actualizar marca de tiempo
    if (saveToSD()) {            // Intentar guardar datos en SD
      Serial.println("Datos guardados en SD");  // Mensaje de √©xito
    } else {
      Serial.println("Error al guardar en SD");  // Mensaje de error
    }
  }

  // Verificar y mantener conexi√≥n MQTT
  if (!client.connected()) {     // Verificar si se perdi√≥ la conexi√≥n MQTT
    reconnectMQTT();             // Reconectar si es necesario
  }
  client.loop();                // Mantener conexi√≥n MQTT activa (procesar mensajes)

  // Env√≠o peri√≥dico a ThingsBoard (cada 5 segundos)
  if (currentMillis - previousMillisMQTT >= intervalMQTT) {  // Verificar si ha pasado el intervalo
    previousMillisMQTT = currentMillis;  // Actualizar marca de tiempo
    sendToThingsBoard();        // Llamar funci√≥n para enviar datos a ThingsBoard
  }
}

// ============ SECCI√ìN 11: LECTURA DE SENSORES ============
void readSensors() {
  // Calcular valores RMS de voltaje y corriente
  emon1.calcVI(20, 2000);  // Calcular valores RMS para sensor 1 (20 ciclos, timeout 2000ms)
  emon2.calcVI(20, 2000);  // Calcular valores RMS para sensor 2 (20 ciclos, timeout 2000ms)
  emon3.calcVI(20, 2000);  // Calcular valores RMS para sensor 3 (20 ciclos, timeout 2000ms)
  
  // Almacenar valores calculados
  volt = emon1.Vrms;   // Obtener voltaje RMS del sensor 1
  line1 = emon1.Irms;  // Obtener corriente RMS de la l√≠nea 1
  line2 = emon2.Irms;  // Obtener corriente RMS de la l√≠nea 2
  line3 = emon3.Irms;  // Obtener corriente RMS de la l√≠nea 3
}

// ============ SECCI√ìN 12: GUARDADO EN TARJETA SD ============
bool saveToSD() {
  myRTC.updateTime();  // Actualizar datos del RTC (leer hora actual)
  
  // Formatear fecha, hora y datos de sensores en buffer
  snprintf(buf, sizeof(buf), "%02d/%02d/%04d,%02d:%02d:%02d,%.2f,%.2f,%.2f,%.2f",
           myRTC.dayofmonth, myRTC.month, myRTC.year,    // Datos de fecha (d√≠a, mes, a√±o)
           myRTC.hours, myRTC.minutes, myRTC.seconds,    // Datos de hora (hora, minuto, segundo)
           volt, line1, line2, line3);                   // Datos de sensores (voltaje, corrientes)

  // Abrir archivo en modo append (agregar al final)
  File dataFile = SD.open("/datalog.csv", FILE_APPEND);  // Abrir archivo para agregar datos
  if (dataFile) {                    // Verificar si se abri√≥ correctamente
    dataFile.println(buf);  // Escribir l√≠nea de datos en el archivo
    dataFile.close();       // Cerrar archivo
    return true;            // Retornar √©xito
  }
  return false;             // Retornar error
}

// ============ SECCI√ìN 13: VISUALIZACI√ìN POR SERIAL ============
void printSerialData() {
  myRTC.updateTime(); // Actualizar datos del RTC (leer hora actual)
  
  // Mostrar fecha y hora en formato legible
  Serial.print("Fecha: ");          // Etiqueta para fecha
  Serial.print(myRTC.dayofmonth);   // D√≠a del mes
  Serial.print("/");                // Separador
  Serial.print(myRTC.month);        // Mes
  Serial.print("/");                // Separador
  Serial.print(myRTC.year);         // A√±o
  Serial.print(" ");                // Espacio
  
  Serial.print("Hora: ");           // Etiqueta para hora
  Serial.print(myRTC.hours);        // Horas
  Serial.print(":");                // Separador
  Serial.print(myRTC.minutes);      // Minutos
  Serial.print(":");                // Separador
  Serial.print(myRTC.seconds);      // Segundos
  Serial.print(" | ");              // Separador
  
  // Mostrar datos de sensores
  Serial.print("V: "); Serial.print(volt);      // Mostrar voltaje
  Serial.print(" | I1: "); Serial.print(line1); // Mostrar corriente l√≠nea 1
  Serial.print(" | I2: "); Serial.print(line2); // Mostrar corriente l√≠nea 2
  Serial.print(" | I3: "); Serial.println(line3); // Mostrar corriente l√≠nea 3 y salto de l√≠nea
}

// ============ SECCI√ìN 14: ENV√çO A THINGSBOARD ============
void sendToThingsBoard() {
  // Construir payload JSON con los datos de los sensores
  String payload = "{";                       // Inicio del objeto JSON
  payload += "\"voltage\":" + String(volt, 2) + ",";      // Agregar voltaje con 2 decimales
  payload += "\"current1\":" + String(line1, 2) + ",";    // Agregar corriente 1 con 2 decimales
  payload += "\"current2\":" + String(line2, 2) + ",";    // Agregar corriente 2 con 2 decimales
  payload += "\"current3\":" + String(line3, 2);          // Agregar corriente 3 con 2 decimales
  payload += "}";                            // Fin del objeto JSON

  Serial.print("üì§ Enviando a ThingsBoard: ");  // Mensaje de env√≠o
  Serial.println(payload);                   // Mostrar payload que se enviar√°

  // Publicar datos en topic MQTT de ThingsBoard
  client.publish("v1/devices/me/telemetry", (char*)payload.c_str());  // Publicar en topic MQTT
}

// ============ SECCI√ìN 15: RECONEXI√ìN MQTT ============
void reconnectMQTT() {
  while (!client.connected()) {     // Intentar hasta que se establezca conexi√≥n
    Serial.print("üîÑ Conectando a ThingsBoard... ");  // Mensaje de intento de conexi√≥n
    // Intentar conexi√≥n con token de dispositivo
    if (client.connect("ESP32Client", deviceToken, NULL)) {  // Conectar con nombre y token
      Serial.println("‚úÖ Conectado a ThingsBoard!");  // Mensaje de conexi√≥n exitosa
    } else {
      Serial.print("‚ùå Fallo, rc=");              // Mensaje de error
      Serial.print(client.state());              // Mostrar estado de error MQTT
      Serial.println(" Reintentando en 5s...");  // Mensaje de reintento
      delay(5000);                              // Esperar 5 segundos antes de reintentar
    }
  }
}
